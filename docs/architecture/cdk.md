# CDK Stack Guide

This document explains how the `infra/cdk` package provisions the production platform for the portfolio and blog. It complements the deeper dive in [OpenNext Integration](./opennext.md).

## Stack Overview

- **Entry point**: `infra/cdk/lib/portfolio-stack.ts` exports `PortfolioStack`, the single stack deployed to AWS.
- **Region requirements**: The stack must be deployed in `us-east-1` because the Next.js server runs as a Lambda@Edge function associated with CloudFront.
- **OpenNext artifacts**: The stack consumes `.open-next/open-next.output.json` to discover bundle locations, origin behaviors, and optional worker functions. Run `pnpm run build:web` at the repo root before synthesizing the stack.
- **Configuration surface**: Environment variables (either shell, `.env.cdk`, or CI secrets) feed into the stack via `PortfolioStackProps.environment`. Helper functions curate which values reach the Edge runtime versus regional Lambdas.

## What the Stack Creates

- **CloudFront distribution** with optional Route53/ACM custom domains. The default behavior invokes the Next.js Lambda@Edge; additional behaviors are generated automatically from OpenNext metadata.
- **S3 buckets**:
  - `AssetsBucket` for static assets and incremental cache data.
  - `BlogContentBucket` for markdown/HTML content generated by the CMS.
  - `BlogMediaBucket` for uploaded images and attachments (with strict lifecycle + CORS rules).
- **Lambda functions**:
  - `ServerEdgeFunction` (Lambda@Edge) for SSR/API handling, patched at deploy time to read runtime headers populated by CloudFront.
  - `ImageOptimizationFunction` (regional) exposed via Function URL but locked behind CloudFront Origin Access Control.
  - `RevalidationWorkerFunction` (optional) that drains the revalidation SQS queue when OpenNext provides a worker bundle.
  - `BlogPublishFunction` (regional) triggered by the admin UI to publish/schedule posts.
  - `CacheInitializationFunction` and any additional OpenNext function origins detected in the build output.
- **Data layer**:
  - `BlogPostsTable` DynamoDB table with a `byStatusPublishedAt` GSI for CMS filtering.
  - `RevalidationTable` DynamoDB table backing Next.js tag cache metadata.
  - `RevalidationQueue` FIFO SQS queue (plus DLQ) for background incremental revalidation.
- **Secrets & IAM**:
  - Optional Secrets Manager references (environment + repo secrets) that are granted to regional Lambdas.
  - An IAM role for EventBridge Scheduler so publish workflows can schedule posts safely.

Refer to [Infrastructure Overview](./infra.md) for a visual summary of these components.

## OpenNext Integration Details

- The stack validates that `.open-next/` exists, then parses `open-next.output.json` to wire origins, behaviors, and auxiliary workers.
- Server bundles are patched via `patchEdgeServerBundle` to add a thin wrapper that reconstructs runtime config from CloudFront origin headers. This lets the Edge runtime avoid direct Secrets Manager access.
- Regional functions receive environment variables through `buildBaseEnvironment`, `injectRuntimeEnvironment`, and `pickRuntimeEnv`. Prefix/allow/block lists (`APP_ENV_PREFIXES`, `APP_ENV_BLOCKLIST`, etc.) keep configuration deliberate.
- CloudFront custom headers (`x-opn-runtime-config-*`) encode a limited subset of configuration for the Edge environment, driven by `EDGE_RUNTIME_ENV_PREFIXES` and `EDGE_RUNTIME_ENV_KEYS`.

## Incremental Revalidation Pipeline

1. The Edge Lambda writes cache metadata to `RevalidationTable` and, when needed, enqueues jobs onto `RevalidationQueue`.
2. `RevalidationWorkerFunction` (regional) processes SQS batches, updates DynamoDB, and triggers incremental static regeneration against the assets bucket.
3. CloudFront invalidation permissions are scoped so only stack-managed functions can request invalidations when regeneration completes.

## Blog Authoring Workflow

- The admin UI uses signed requests to invoke `BlogPublishFunction`, which writes CMS metadata to `BlogPostsTable` and manages scheduling through the shared scheduler role.
- Media uploads flow to `BlogMediaBucket` via presigned URLs; content snapshots land in `BlogContentBucket`.
- Environment variables such as `MEDIA_BUCKET`, `CONTENT_BUCKET`, and `SCHEDULER_ROLE_ARN` are injected automatically so API routes know where to persist assets.

## Deploying & Validating

```bash
# 1. Build the Next.js artifacts
pnpm run build:web

# 2. Deploy the CDK stack
cd infra/cdk
pnpm install
pnpm run check        # tsc + custom validation
export CDK_DEFAULT_ACCOUNT=<aws-account-id>
export CDK_DEFAULT_REGION=us-east-1
pnpm cdk bootstrap    # once per account/region
pnpm cdk deploy
```

Useful scripts:

- `pnpm cdk diff` – preview changes before deployment.
- `pnpm cdk destroy` – tear down the stack (be cautious; buckets/tables retain data by default).
- `pnpm run validate` – local assertion that OpenNext bundles exist and that required env vars are present.

## Observability & Operations

- Every Lambda has a dedicated CloudWatch Log Group with a finite retention window (2 weeks by default).
- CloudFront and S3 metrics capture cache hit ratios and origin latency; use the distribution ID output after deploy.
- DynamoDB tables enable PITR (blog posts) and secondary indexes for operational recovery.
- For troubleshooting, see `../operations/log-diving.md`.

## Related Reading

- [OpenNext Integration](./opennext.md) – deep dive on OpenNext integration and runtime configuration.
- [Admin UI](../features/admin-ui.md) – explains how the admin CMS uses the infrastructure.
- [Infrastructure Overview](./infra.md) – high-level diagram of the deployed stack.
