%% Figure 3.0 -- Offline Preprocessing Pipeline
%% Output: portfolio-chat-preprocessing.png
flowchart LR
  %% === Sources ===
  subgraph SOURCES["Source Data"]
    GIST["GitHub Gist\n(PortfolioRepoConfig[])"]
    GH["GitHub Repos\n(README-only)"]
    RESUME_PDF[["Resume PDF"]]
    PROFILE_MD[["data/chat/profile.md"]]
  end

  %% === Preprocess CLI ===
  subgraph CLI["chat-preprocess-cli"]
    SUB_GH["Repo fetch + README extract"]
    ENRICH_PROJ["Project Enrichment\ngpt-5.1"]
    EMB_PROJ["text-embedding-3-large\nfor projects"]

    PDF_TXT["PDF -> Text"]
    STRUCT_RESUME["Resume Structuring\ngpt-5.1"]
    EMB_RES["text-embedding-3-large\nfor resume"]

    STRUCT_PROFILE["Profile Structuring\ngpt-5.1"]
    PERSONA["Persona Synthesis\ngpt-5.1"]

    LINK["Cross-corpus Linking\n(linkedToCompanies)"]
    VALIDATE["Validation & Consistency\n(no partial outputs)"]
    METRICS["Metrics Logging\n(tokens, cost, failures)"]
  end

  %% === Outputs ===
  subgraph GEN["generated/ artifacts"]
    GEN_PROJ[(projects.json)]
    GEN_PROJ_EMB[(projects-embeddings.json)]
    GEN_RES[(resume.json)]
    GEN_RES_EMB[(resume-embeddings.json)]
    GEN_PROF[(profile.json)]
    GEN_PERSONA[(persona.json)]
    GEN_METRICS[(metrics/preprocess-<runId>.json)]
  end

  %% --- Flows ---
  GIST --> SUB_GH
  SUB_GH --> GH

  GH --> ENRICH_PROJ
  ENRICH_PROJ --> GEN_PROJ
  ENRICH_PROJ --> EMB_PROJ
  EMB_PROJ --> GEN_PROJ_EMB

  RESUME_PDF --> PDF_TXT --> STRUCT_RESUME
  STRUCT_RESUME --> GEN_RES
  STRUCT_RESUME --> EMB_RES
  EMB_RES --> GEN_RES_EMB

  PROFILE_MD --> STRUCT_PROFILE --> GEN_PROF
  STRUCT_PROFILE --> PERSONA --> GEN_PERSONA

  GEN_PROJ --> LINK
  GEN_RES --> LINK
  LINK --> VALIDATE
  VALIDATE --> GEN_METRICS
  ENRICH_PROJ --> METRICS
  STRUCT_RESUME --> METRICS
  STRUCT_PROFILE --> METRICS
  PERSONA --> METRICS
  EMB_PROJ --> METRICS
  EMB_RES --> METRICS
  METRICS --> GEN_METRICS
