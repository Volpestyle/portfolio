%% Figure 6.1 -- Frontend SSE Event Handling
%% Output: portfolio-chat-sse-handling.png
flowchart LR
  %% === SSE Source ===
  SSE[/"SSE stream\nfrom /api/chat"/]

  subgraph ROUTER["Event Router & State"]
    ROUTE["EventSource handlers\nswitch(event)"]

    subgraph CHAT_STATE["Chat Thread State"]
      TOKENS["Append streamed tokens\nto active assistant message"]
      ITEMS["Non-token items\n(event: item)"]
      MSGS["Messages list\n(history per conversationId)"]
    end

    subgraph UI_STATE["UI & Progress State"]
      STAGE["Pipeline progress + meta\n(planner / retrieval / evidence / answer)"]
      CARDS["Cards state\n(showProjects, showExperiences)"]
      ACTIONS["UI actions queue\n(ui_actions events)"]
      ATTACH["Attachments/downloads\n(event: attachment)"]
      ERR_STATE["Error state\n(code, message, retryable)"]
      DONE_STATE["Done state\n(duration, truncationApplied)"]
    end

    subgraph DEVTOOLS["Optional Dev Reasoning UI"]
      REASON["PartialReasoningTrace\n(plan, retrieval, evidence, answerMeta)"]
    end
  end

  subgraph RENDER["React UI Components"]
    CHAT_UI["Chat thread UI\n(bubbles, typing indicator)"]
    CARDS_UI["Portfolio cards UI\n(projects & experiences)"]
    ACTIONS_UI["Host UI actions\n(highlight/scroll/filter)"]
    ATTACH_UI["Attachments/download UI"]
    PROGRESS_UI[Stage/progress indicator]
    ERROR_UI[Error banner / retry button]
    DEV_UI["Devtools panel\n(reasoning, metrics)"]
  end

  %% --- Wiring: SSE -> Router ---
  SSE --> ROUTE

  %% --- Routing by event type ---
  ROUTE -->|event: token| TOKENS
  ROUTE -->|event: item| ITEMS
  TOKENS --> MSGS
  ITEMS --> MSGS

  ROUTE -->|event: stage| STAGE
  ROUTE -->|event: ui| CARDS
  ROUTE -->|event: ui_actions| ACTIONS
  ROUTE -->|event: attachment| ATTACH
  ROUTE -->|event: reasoning| REASON
  ROUTE -->|event: error| ERR_STATE
  ROUTE -->|event: done| DONE_STATE

  %% --- State -> UI ---
  MSGS --> CHAT_UI
  TOKENS --> CHAT_UI
  ITEMS --> CHAT_UI
  STAGE --> PROGRESS_UI
  CARDS --> CARDS_UI
  ACTIONS --> ACTIONS_UI
  ATTACH --> ATTACH_UI
  ERR_STATE --> ERROR_UI
  DONE_STATE --> PROGRESS_UI

  REASON --> DEV_UI
