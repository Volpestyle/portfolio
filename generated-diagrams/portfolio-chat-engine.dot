digraph PortfolioChatEngine {
  graph [
    label="Portfolio Chat Engine — High-Level Architecture (Planner → Retrieval → Answer)",
    labelloc="t",
    fontsize=14,
    fontname="Inter, Helvetica, Arial",
    bgcolor="white",
    rankdir="LR",
    nodesep=0.5,
    ranksep=0.7,
    splines=true
  ];

  node [
    fontname="Inter, Helvetica, Arial",
    fontsize=10,
    shape=box,
    style="rounded,filled",
    fillcolor="#f8fafc",
    color="#cbd5f5"
  ];

  edge [
    fontname="Inter, Helvetica, Arial",
    fontsize=9,
    color="#64748b",
    arrowsize=0.7
  ];

  // =========================
  // Frontend & Chat API
  // =========================
  subgraph cluster_frontend {
    label="Frontend (Next.js)";
    fontsize=11;
    fontname="Inter, Helvetica, Arial";
    color="#e2e8f0";
    style="rounded";

    user [label="User", shape=oval, fillcolor="#e0f2fe", color="#7fb4ff"];

    frontend_ui [
      label="Chat UI\n(threads, composer, reasoning drawer,\nportfolio cards)",
      shape=box,
      fillcolor="#eff6ff"
    ];
  }

  subgraph cluster_api {
    label="Chat API (Next.js /api/chat)";
    fontsize=11;
    fontname="Inter, Helvetica, Arial";
    color="#e2e8f0";
    style="rounded";

    chat_api [
      label="Chat API Handler\n- Validates ChatRequestPayload\n- Binds ownerId\n- Streams SSE events\n(item, token, ui, reasoning, done)"
    ];
  }

  // =========================
  // Runtime Config
  // =========================
  subgraph cluster_config {
    label="Runtime Configuration";
    fontsize=11;
    fontname="Inter, Helvetica, Arial";
    color="#e2e8f0";
    style="rounded";

    owner_config [
      label="OwnerConfig\n- ownerId\n- ownerName\n- pronouns\n- domainLabel\n- portfolioKind?",
      fillcolor="#fefce8"
    ];

    model_config [
      label="ModelConfig\n- plannerModel\n- answerModel\n- embeddingModel\n- reasoning? (planner/answer)",
      fillcolor="#fefce8"
    ];

    data_providers [
      label="DataProviders\n- projects\n- resume\n- profile\n- persona\n- embeddingIndexes",
      fillcolor="#fefce8"
    ];
  }

  // =========================
  // Orchestrator & Pipeline
  // =========================
  subgraph cluster_orchestrator {
    label="Chat Orchestrator (packages/chat-orchestrator)";
    fontsize=11;
    fontname="Inter, Helvetica, Arial";
    color="#e2e8f0";
    style="rounded";

    orchestrator [
      label="ChatRuntime\n(createChatRuntime)\n- Planner → Retrieval → Answer\n- Builds ReasoningTrace & UiPayload\n- Enforces invariants",
      shape=component,
      fillcolor="#eef2ff"
    ];

    planner [
      label="Planner\n- Query construction\n- cardsEnabled/topic\n- PlannerLLMOutput",
      fillcolor="#e0f2fe"
    ];

    retrieval [
      label="Retrieval Engine\n(packages/chat-data)\n- BM25 shortlist\n- Embedding re-ranking\n- Recency scoring\n- Cards toggle respected",
      fillcolor="#e0f2fe"
    ];

    answer [
      label="Answer Stage\n- AnswerPayload\n(message, thoughts?, uiHints)\n- Uses retrieved docs + plan metadata",
      fillcolor="#e0f2fe"
    ];

    { rank = same; planner; retrieval; answer; }
  }

  // =========================
  // Data & Retrieval Layer
  // =========================
  subgraph cluster_data {
    label="Retrieval & Data Layer (packages/chat-data)";
    fontsize=11;
    fontname="Inter, Helvetica, Arial";
    color="#e2e8f0";
    style="rounded";

    projects_corpus [
      label="Projects Corpus\n(ProjectDoc[])",
      fillcolor="#f1f5f9"
    ];

    resume_corpus [
      label="Resume Corpus\n(ResumeDoc[]: experiences,\neducation, awards, skills)",
      fillcolor="#f1f5f9"
    ];

    profile_corpus [
      label="Profile\n(ProfileDoc | null)",
      fillcolor="#f1f5f9"
    ];

    persona_summary [
      label="PersonaSummary\n(style, tone, key facts)",
      fillcolor="#f1f5f9"
    ];

    embedding_indexes [
      label="EmbeddingIndexes\n- projects\n- resume\n- profile?",
      fillcolor="#f1f5f9"
    ];
  }

  // =========================
  // Reasoning Trace & UI
  // =========================
  reasoning_trace [
    label="ReasoningTrace\n(plan, retrieval, answer)\n+ partial streaming traces",
    shape=note,
    fillcolor="#fef9c3"
  ];

  ui_payload [
    label="UiPayload\n- showProjects\n- showExperiences",
    shape=note,
    fillcolor="#fef9c3"
  ];

  // =========================
  // Wiring
  // =========================
  user -> frontend_ui [label="chat"];
  frontend_ui -> chat_api [label="POST /api/chat\nSSE listen"];
  chat_api -> orchestrator [label="ChatRequestPayload\n(messages, ownerId,\nreasoningEnabled)"];

  owner_config -> chat_api [style="dashed", label="bind ownerId"];
  model_config -> chat_api [style="dashed", label="model names"];

  data_providers -> retrieval [label="datasets"];
  embedding_indexes -> retrieval [style="dashed", label="embeddings"];

  orchestrator -> planner [label="system prompt\n+ userContent"];
  planner -> retrieval [label="PlannerLLMOutput\n(queries, cardsEnabled, topic)"];
  retrieval -> answer [label="retrieved docs\n(projects, resume, profile)"];

  answer -> ui_payload [label="AnswerPayload.uiHints\n(filtered to retrieved IDs)"];
  answer -> reasoning_trace [label="answer model + uiHints\n(thoughts optional)"];
  planner -> reasoning_trace [label="plan trace"];
  retrieval -> reasoning_trace [label="retrieval summaries"];

  ui_payload -> frontend_ui [label="cards render"];
  reasoning_trace -> frontend_ui [label="reasoning panel"];
}
