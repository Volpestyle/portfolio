%% Figure 5.0 -- Pipeline Stage Internals (Simplified)
%% Output: portfolio-chat-pipeline-internals.png
flowchart TB
  %% === Inputs ===
  USER_MSG["Latest user message\n+ sliding-window conversation history"]
  ID_CONTEXT["Identity context\n(OwnerConfig + ProfileDoc)"]
  PERSONA["PersonaSummary\n(from preprocess)"]
  CORPORA[(Projects / Resume / Profile\ncorpora + embedding indexes)]

  %% === Pipeline Stages ===
  subgraph PLANNER["Planner (LLM)"]
    P_IN["Inputs:\nsystem prompt,\nconversation window,\nlatest user message"]
    P_OUT["PlannerLLMOutput\n(queries[], topic?)"]
  end

  subgraph RETR["Retrieval Engine"]
    RET_BM25["BM25 shortlist"]
    RET_EMB["Embedding re-rank\n(cosine similarity)"]
    RET_REC["Recency scoring"]
    RET_OUT["Retrieved docs +\nRetrievalSummary[]"]
  end

  subgraph ANSWER["Answer (LLM, streaming)"]
    A_IN["Inputs:\npersona + identity context,\nPlannerLLMOutput,\nretrieved docs"]
    A_OUT["AnswerPayload\n(streamed message,\noptional thoughts,\nuiHints)"]
  end

  subgraph UI["UI Derivation"]
    UI_DERIVE["deriveUi()\nvalidate uiHints IDs\nfilter/dedupe/truncate"]
    UI_PAYLOAD["UiPayload\n(showProjects,\nshowExperiences)"]
  end

  REASON["PartialReasoningTrace\n(plan, retrieval, answer)"]

  %% === Flow ===
  USER_MSG --> P_IN
  ID_CONTEXT --> P_IN
  CORPORA --> ID_CONTEXT
  P_IN --> P_OUT

  CORPORA --> RET_BM25
  CORPORA --> RET_EMB
  P_OUT --> RET_BM25
  P_OUT --> RET_EMB
  RET_BM25 --> RET_EMB
  RET_EMB --> RET_REC
  RET_REC --> RET_OUT

  P_OUT --> A_IN
  RET_OUT --> A_IN
  PERSONA --> A_IN
  ID_CONTEXT --> A_IN
  A_IN --> A_OUT

  P_OUT --> UI_DERIVE
  A_OUT --> UI_DERIVE
  RET_OUT --> UI_DERIVE
  UI_DERIVE --> UI_PAYLOAD

  P_OUT --> REASON
  RET_OUT --> REASON
  A_OUT --> REASON

  %% === SSE outputs ===
  UI_CLIENT[[Frontend Chat UI]]
  A_OUT -->|SSE token events| UI_CLIENT
  UI_PAYLOAD -->|SSE ui events| UI_CLIENT
  REASON -->|SSE reasoning events| UI_CLIENT
