name: Deploy (production)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: GitHub environment (defaults to production)
        required: false
        default: production
        type: environment
      skip_tests:
        description: Skip E2E and smoke tests (quick patch mode)
        required: false
        default: false
        type: boolean

# OIDC for AWS + read access to repo
permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  # --- Quick patch mode: add [skip] to commit message to skip tests ---
  SKIP_TESTS: ${{ contains(github.event.head_commit.message, '[skip]') || inputs.skip_tests == true }}

  # --- Paths (adjust if your layout differs) ---
  # Root of your Next.js app that contains open-next.config.(ts|mjs|cjs)
  APP_ROOT: ${{ vars.NEXT_APP_PATH || '.' }}
  # CDK package directory (where package.json with "cdk" scripts lives)
  CDK_WORKDIR: ${{ vars.CDK_WORKDIR || 'infra/cdk' }}

  # --- Tooling versions ---
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

  # --- Required by your stack / code paths ---
  # Region must be us-east-1 due to Lambda@Edge in your app code.
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}

  # These map straight into process.env read by your CDK app
  APP_DOMAIN_NAME: ${{ vars.APP_DOMAIN_NAME }}
  APP_HOSTED_ZONE_DOMAIN: ${{ vars.APP_HOSTED_ZONE_DOMAIN }}
  APP_CERTIFICATE_ARN: ${{ vars.APP_CERTIFICATE_ARN }}
  APP_ALTERNATE_DOMAINS: ${{ vars.APP_ALTERNATE_DOMAINS }}

  # Secrets Manager ids used by your stack to mount runtime secrets
  SECRETS_MANAGER_ENV_SECRET_ID: ${{ vars.SECRETS_MANAGER_ENV_SECRET_ID }}
  SECRETS_MANAGER_REPO_SECRET_ID: ${{ vars.SECRETS_MANAGER_REPO_SECRET_ID }}

  # Optional repo variables you referenced
  PORTFOLIO_GIST_ID: ${{ vars.PORTFOLIO_GIST_ID }}
  UPSTASH_REDIS_REST_URL: ${{ vars.UPSTASH_REDIS_REST_URL }}
  ADMIN_EMAILS: ${{ vars.ADMIN_EMAILS }}
  GH_CLIENT_ID: ${{ vars.GH_CLIENT_ID }}
  GH_CLIENT_SECRET: ${{ secrets.GH_CLIENT_SECRET }}
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}

jobs:
  deploy:
    name: Build & CDK deploy (us-east-1)
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || 'production' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node with pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # ----- AWS access for build-time data -----
      - name: Configure AWS credentials for build (OIDC)
        if: ${{ vars.CDK_DEPLOY_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.CDK_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Resolve deployed resource names for SSR build
        id: resolve-runtime
        run: |
          set -euo pipefail

          echo "Attempting to load CloudFormation outputs for PortfolioStack..."
          outputs_json=$(aws cloudformation describe-stacks \
            --stack-name PortfolioStack \
            --query 'Stacks[0].Outputs' \
            --output json 2>/dev/null || true)

          if [ -z "$outputs_json" ] || [ "$outputs_json" = "null" ]; then
            echo "PortfolioStack not found (likely first deploy). Falling back to fixture runtime for this build."
            echo "BLOG_TEST_FIXTURES=true" >> "$GITHUB_ENV"
            echo "PORTFOLIO_TEST_FIXTURES=true" >> "$GITHUB_ENV"
            exit 0
          fi

          export_output () {
            local key="$1"
            local env_name="$2"
            local value
            value=$(echo "$outputs_json" | jq -r ".[] | select(.OutputKey==\"${key}\") | .OutputValue" | head -n 1)
            if [ -z "$value" ] || [ "$value" = "null" ]; then
              echo "Missing CloudFormation output ${key}. Falling back to fixture runtime for this build."
              echo "BLOG_TEST_FIXTURES=true" >> "$GITHUB_ENV"
              echo "PORTFOLIO_TEST_FIXTURES=true" >> "$GITHUB_ENV"
              exit 0
            fi
            echo "${env_name}=${value}" >> "$GITHUB_ENV"
            export "${env_name}=${value}"
          }

          export_output "BlogPostsTableName" "POSTS_TABLE"
          export_output "BlogContentBucketName" "CONTENT_BUCKET"
          export_output "BlogMediaBucketName" "MEDIA_BUCKET"
          export_output "AssetBucketName" "CACHE_BUCKET_NAME"

          echo "Resolved runtime resources for build: POSTS_TABLE=${POSTS_TABLE}, CONTENT_BUCKET=${CONTENT_BUCKET}, MEDIA_BUCKET=${MEDIA_BUCKET}"

      # ----- Build your Next.js app with OpenNext (produces .open-next) -----
      - name: Install app dependencies
        working-directory: ${{ env.APP_ROOT }}
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: ${{ env.APP_ROOT }}
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright system deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        working-directory: ${{ env.APP_ROOT }}
        run: pnpm exec playwright install-deps chromium

      - name: Build Next.js with OpenNext
        working-directory: ${{ env.APP_ROOT }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PORTFOLIO_GIST_ID: ${{ env.PORTFOLIO_GIST_ID }}
        run: |
          pnpm dlx @opennextjs/aws@latest build
          test -f .open-next/open-next.output.json

      - name: Run E2E Tests
        if: ${{ env.SKIP_TESTS != 'true' }}
        working-directory: ${{ env.APP_ROOT }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PORTFOLIO_GIST_ID: ${{ env.PORTFOLIO_GIST_ID }}
          CI: true
          # Keep Playwright in mock mode for deterministic data & so local dev environments aren't required
          BLOG_TEST_FIXTURES: 'true'
          PORTFOLIO_TEST_FIXTURES: 'true'
        run: pnpm test

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      # ----- Prepare CDK workspace -----
      - name: Install CDK workspace deps
        working-directory: ${{ env.CDK_WORKDIR }}
        run: pnpm install --frozen-lockfile

      - name: Build CDK (TypeScript)
        working-directory: ${{ env.CDK_WORKDIR }}
        run: pnpm run build

      # ----- Configure AWS credentials -----
      # Prefer OIDC with a deploy role (recommended)
      - name: Configure AWS credentials (OIDC)
        if: ${{ vars.CDK_DEPLOY_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.CDK_DEPLOY_ROLE_ARN }}
          aws-region: us-east-1

      - name: Validate stack configuration
        working-directory: ${{ env.CDK_WORKDIR }}
        env:
          NEXT_PUBLIC_SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL }}
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
        run: pnpm run validate

      # ----- Deploy -----
      - name: CDK deploy PortfolioStack
        working-directory: ${{ env.CDK_WORKDIR }}
        env:
          # Surface runtime secrets/vars required by your code at synth time;
          # your stack then passes them into Lambda env via collectLambdaEnv().
          PORTFOLIO_GIST_ID: ${{ env.PORTFOLIO_GIST_ID }}
          UPSTASH_REDIS_REST_URL: ${{ env.UPSTASH_REDIS_REST_URL }}
          APP_DOMAIN_NAME: ${{ env.APP_DOMAIN_NAME }}
          APP_HOSTED_ZONE_DOMAIN: ${{ env.APP_HOSTED_ZONE_DOMAIN }}
          APP_CERTIFICATE_ARN: ${{ env.APP_CERTIFICATE_ARN }}
          APP_ALTERNATE_DOMAINS: ${{ env.APP_ALTERNATE_DOMAINS }}
          SECRETS_MANAGER_ENV_SECRET_ID: ${{ env.SECRETS_MANAGER_ENV_SECRET_ID }}
          SECRETS_MANAGER_REPO_SECRET_ID: ${{ env.SECRETS_MANAGER_REPO_SECRET_ID }}
          NEXT_PUBLIC_SITE_URL: ${{ vars.NEXT_PUBLIC_SITE_URL }}
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
        run: |
          pnpm exec cdk deploy PortfolioStack --require-approval never --verbose

      # ----- Invalidate CloudFront cache for ISR pages -----
      - name: Get CloudFront Distribution ID
        id: get-distribution
        working-directory: ${{ env.CDK_WORKDIR }}
        run: |
          DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name PortfolioStack \
            --query "Stacks[0].Outputs[?OutputKey=='DistributionId'].OutputValue" \
            --output text)
          echo "distribution_id=$DIST_ID" >> $GITHUB_OUTPUT
          echo "Found CloudFront Distribution: $DIST_ID"

      - name: Invalidate CloudFront cache
        if: steps.get-distribution.outputs.distribution_id != ''
        run: |
          echo "Creating invalidation for CloudFront distribution ${{ steps.get-distribution.outputs.distribution_id }}"
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.get-distribution.outputs.distribution_id }} \
            --paths "/blog" "/blog/*" "/projects" "/projects/*" "/api/*" "/api/github/*" "/_next/data/*" \
            --query 'Invalidation.Id' \
            --output text
          echo "CloudFront cache invalidation created successfully"
      - name: Revalidate server caches
        env:
          TARGET_URL: ${{ vars.API_INTEGRATION_BASE_URL != '' && vars.API_INTEGRATION_BASE_URL || (env.APP_DOMAIN_NAME != '' && format('https://{0}', env.APP_DOMAIN_NAME)) }}
          REVALIDATE_SECRET: ${{ secrets.REVALIDATE_SECRET }}
        run: |
          if [ -z "${TARGET_URL}" ]; then
            echo "No target URL configured, skipping server cache revalidation."
            exit 0
          fi
          payload='{"paths":["/projects","/blog","/_next/data/*","/api/github/portfolio-repos","/api/blog/posts"],"tags":["github-repos","posts"]}'
          attempts=5
          delay=5

          for attempt in $(seq 1 $attempts); do
            echo "Sending revalidate request to ${TARGET_URL} (attempt ${attempt}/${attempts})"
            response_file="$(mktemp)"
            status_code=$(curl -sS -w "%{http_code}" -o "${response_file}" \
              -X POST "${TARGET_URL}/api/revalidate" \
              -H 'content-type: application/json' \
              -H "x-revalidate-secret: ${REVALIDATE_SECRET}" \
              --data "${payload}" \
              --fail-with-body \
              --max-time 20 \
              --connect-timeout 5 || true)
            status_code=${status_code:-000}

            if [ "${status_code}" -ge 200 ] && [ "${status_code}" -lt 300 ]; then
              echo "Server caches revalidated (status ${status_code})."
              rm -f "${response_file}"
              exit 0
            fi

            echo "Revalidate request failed with status ${status_code}: $(cat "${response_file}" 2>/dev/null)"
            rm -f "${response_file}"

            if [ "${attempt}" -lt "${attempts}" ]; then
              echo "Retrying in ${delay}s..."
              sleep "${delay}"
              delay=$((delay * 2))
            else
              echo "Revalidation failed after ${attempts} attempts."
              exit 1
            fi
          done

  smoke-tests:
    name: Post-deploy smoke tests
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ (vars.API_INTEGRATION_BASE_URL != '' || vars.APP_DOMAIN_NAME != '') && !contains(github.event.head_commit.message, '[skip]') && inputs.skip_tests != true }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Enable pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node with pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install app dependencies
        working-directory: ${{ env.APP_ROOT }}
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache-smoke
        with:
          path: ~/.cache/ms-playwright
          key: playwright-chromium-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache-smoke.outputs.cache-hit != 'true'
        working-directory: ${{ env.APP_ROOT }}
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Playwright system deps only
        if: steps.playwright-cache-smoke.outputs.cache-hit == 'true'
        working-directory: ${{ env.APP_ROOT }}
        run: pnpm exec playwright install-deps chromium

      - name: Run real API smoke tests
        working-directory: ${{ env.APP_ROOT }}
        env:
          CI: true
          PLAYWRIGHT_SKIP_WEBSERVER: 'true'
          E2E_USE_REAL_APIS: 'true'
          E2E_API_BASE_URL: ${{ vars.API_INTEGRATION_BASE_URL != '' && vars.API_INTEGRATION_BASE_URL || (vars.APP_DOMAIN_NAME != '' && format('https://{0}', vars.APP_DOMAIN_NAME)) }}
          E2E_API_REPO_OWNER: ${{ vars.API_INTEGRATION_REPO_OWNER }}
          E2E_API_REPO_NAME: ${{ vars.API_INTEGRATION_REPO_NAME }}
          E2E_API_DOC_PATH: ${{ vars.API_INTEGRATION_DOC_PATH }}
        run: pnpm run test:real-api

      - name: Run real UI smoke tests
        working-directory: ${{ env.APP_ROOT }}
        env:
          CI: true
          PLAYWRIGHT_SKIP_WEBSERVER: 'true'
          E2E_USE_REAL_APIS: 'true'
          PLAYWRIGHT_TEST_BASE_URL: ${{ vars.API_INTEGRATION_BASE_URL != '' && vars.API_INTEGRATION_BASE_URL || (vars.APP_DOMAIN_NAME != '' && format('https://{0}', vars.APP_DOMAIN_NAME)) }}
          E2E_API_BASE_URL: ${{ vars.API_INTEGRATION_BASE_URL != '' && vars.API_INTEGRATION_BASE_URL || (vars.APP_DOMAIN_NAME != '' && format('https://{0}', vars.APP_DOMAIN_NAME)) }}
        run: pnpm run test:real-ui

      - name: Upload smoke test report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-smoke
          path: playwright-report/
          retention-days: 30
